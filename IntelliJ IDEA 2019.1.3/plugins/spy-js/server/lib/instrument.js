/*
 * spy-js - v2.0.0
 * http://spy-js.com
 * Copyright (c) 2013-2017 JetBrains - All Rights Reserved.
 *
 * This source code file is a part of spy-js plugin.
 */
var _=require("lodash/dist/lodash.underscore"),acorn=require("acorn/dist/acorn"),parser=acorn.Parser,tokTypes=acorn.tokTypes,escodegen=require("escodegen"),sourceMapTransfer=require("multi-stage-sourcemap").transfer,SourceMapConsumer=require("source-map").SourceMapConsumer,urlUtil=require("url"),acornParseStatement=parser.prototype.parseStatement;parser.prototype.parseStatement=function(a,b){var c=this.type;return c===tokTypes._function&&(arguments[0]=!0),acornParseStatement.apply(this,arguments)};var programScopeToken="[p]:",anonymousScopeCounter=0,anonymousNameBuilder=function(){return"[a]:"+anonymousScopeCounter++},anonymousIIFENameBuilder=function(){return"[i]:"+anonymousScopeCounter++},anonymousReturnNameBuilder=function(a){return"[r]:"+anonymousScopeCounter++ +":"+a},anonymousArgNameBuilder=function(a){return"[c]:"+anonymousScopeCounter++ +":"+a},Instrumentor=function(a){var b=this;if(b._funcId=0,this._options=_.defaults(a||{},{insObjName:"__p",insFuncName:"i",insGenFuncName:"ig",insFuncFuncStartName:"f",insGenFuncFuncStartName:"fg",insFuncFuncEndName:"fe",insGenFuncFuncEndName:"fge",insFuncProgStartName:"p",insFuncProgEndName:"pe",insFuncReturnName:"r",insGenFuncReturnName:"rg",insFuncReturnUndefinedName:"ru",insGenFuncReturnUndefinedName:"rgu",insFuncExceptionName:"e",insGenFuncExceptionName:"eg",insFuncScopeEvaluatorName:"v",insFuncBeforeYieldName:"by",insFuncAfterYieldName:"ay",insFuncArgsName:"args",timeFuncName:"t",exIdentifier:"__ex",expIdentifier:"__e",fileId:0,file:void 0,sourceMap:void 0,prettify:void 0,compact:!1,allowReturnOutsideFunction:!1,insertExpressionEvaluators:!1}),this._options.sourceMap&&!this._options.file)throw new Error("File name/path (file property) must be specified when source map generation is on (sourceMap property set)");this._options.file&&!this._options.fileId&&(this._options.fileId=this._options.file),this.fileIdLiteral=this._literal(this._options.fileId),this._visitor=this._nodeVisitorConstructor(),this._visitor.AssignmentExpression.add(function(a){!a.left||!a.right||"FunctionExpression"!==a.right.type&&"ArrowFunctionExpression"!==a.right.type||"VariableDeclarator"===a.left.type&&a.left.id||(a._leftName=escodegen.generate(a.left,{format:{compact:!0}}))}),this._visitor.AssignmentPattern.add(function(a){!a.left||!a.right||"FunctionExpression"!==a.right.type&&"ArrowFunctionExpression"!==a.right.type||"VariableDeclarator"===a.left.type&&a.left.id||(a._leftName=escodegen.generate(a.left,{format:{compact:!0}}))}),this._visitor.CallExpression.add(function(a){a.callee&&a.arguments&&_.find(a.arguments,function(a){return"FunctionExpression"===a.type||"ArrowFunctionExpression"===a.type||"CallExpression"===a.type&&a.callee&&"MemberExpression"===a.callee.type&&a.callee.object&&("FunctionExpression"===a.callee.object.type||"ArrowFunctionExpression"===a.callee.object.type)})&&(a._calleeName=escodegen.generate(a.callee,{format:{compact:!0}}))}),this._visitor.IfStatement.add(function(a){a.consequent&&"BlockStatement"!==a.consequent.type&&(a.consequent=b._wrapInBlock([a.consequent])),a.alternate&&"BlockStatement"!==a.alternate.type&&"IfStatement"!==a.alternate.type&&(a.alternate=b._wrapInBlock([a.alternate]))}),this._visitor.add([this._visitor.DoWhileStatement,this._visitor.WhileStatement,this._visitor.IfStatement,this._visitor.ForStatement],function(a,c){a.test&&(a.test=b._sequence([b._instruction(b._encodeInstructionArgs(a.test.loc,"TST",c),c),a.test]))}),this._visitor.SwitchStatement.add(function(a,c){a.discriminant=b._sequence([b._instruction(b._encodeInstructionArgs(a.discriminant.loc,"SWT",c),c),a.discriminant])}),this._visitor.SwitchCase.add(function(a){a.consequent&&a.consequent.length>0&&(1!=a.consequent.length||"BlockStatement"!==a.consequent[0].type)&&(a.consequent=[b._wrapInBlock(a.consequent)])}),this._visitor.add([this._visitor.DoWhileStatement,this._visitor.ForInStatement,this._visitor.ForStatement,this._visitor.ForOfStatement,this._visitor.LabeledStatement,this._visitor.WhileStatement,this._visitor.WithStatement],function(a){a.body&&"BlockStatement"!==a.body.type&&("LabeledStatement"!==a.type||"DoWhileStatement"!==a.body.type&&"ForInStatement"!==a.body.type&&"ForStatement"!==a.body.type&&"WhileStatement"!==a.body.type)&&"ForOfStatement"!==a.body.type&&(a.body=b._wrapInBlock([a.body]))}),this._visitor.add([this._visitor.BreakStatement,this._visitor.ContinueStatement,this._visitor.ThrowStatement],function(a,c){if(!c.parentNode||"ForStatement"!==c.parentNode.type&&"ForInStatement"!==c.parentNode.type&&"ForOfStatement"!==c.parentNode.type&&"ExportDefaultDeclaration"!==c.parentNode.type&&"ExportNamedDeclaration"!==c.parentNode.type){var d=b._encodeInstructionArgs(a.loc,"S",c),e=[b._instructionStatement(d,c),a];c.replacement=b._wrapInBlock(e)}}),this._visitor.VariableDeclaration.add(function(a,c){if((!c.parentNode||"ForStatement"!==c.parentNode.type&&"ForInStatement"!==c.parentNode.type&&"ForOfStatement"!==c.parentNode.type&&"ExportDefaultDeclaration"!==c.parentNode.type&&"ExportNamedDeclaration"!==c.parentNode.type)&&a.declarations&&a.declarations[0]&&"VariableDeclarator"===a.declarations[0].type){var d=a.declarations[0],e=b._encodeInstructionArgs(a.loc,"S",c),f=b._instruction(e,c,a.loc);d.init=d.init?b._sequence([f,d.init]):"var"===a.kind?{type:"LogicalExpression",operator:"||",left:{type:"Identifier",name:d.id.name},right:f}:f}}),this._visitor.ExpressionStatement.add(function(a,c){var d=b._encodeInstructionArgs(a.loc,"S",c),e=b._instruction(d,c,a.loc);a.expression=b._sequence([e,a.expression])}),this._visitor.ReturnStatement.add(function(a,c){var d=b._encodeInstructionArgs(a.loc,"R",c),e=a.argument?a.argument.loc:a.loc;a.argument=b._sequence([b._instruction(b._encodeInstructionArgs(e,"RB",c),c,e),b._instructionReturn(d,c,a.argument,a.loc)])}),this._visitor.ConditionalExpression.add(function(a,c){a.consequent=b._sequence([b._instruction(b._encodeInstructionArgs(a.consequent.loc,"CDC",c),c),a.consequent]),a.alternate=b._sequence([b._instruction(b._encodeInstructionArgs(a.alternate.loc,"CDA",c),c),a.alternate])}),this._visitor.LogicalExpression.add(function(a,c){a.left=b._sequence([b._instruction(b._encodeInstructionArgs(a.left.loc,"LGL",c),c),a.left]),a.right=b._sequence([b._instruction(b._encodeInstructionArgs(a.right.loc,"LGR",c),c),a.right])}),this._visitor.YieldExpression.add(function(a,c){var d=b._encodeInstructionArgs(a.loc,"FE",c);a.argument=b._instructionBeforeYield(d,a.argument,c,a.loc),c.replacement=b._instructionAfterYield(a,c,a.loc)}),this._visitor.Program.add(function(a,c){b._funcId++,c.func=programScopeToken,c.gen=!1,c.id=b._currentFunctionId();var d=b._encodeInstructionArgs(a.loc,"PS",c),e=b._encodeInstructionArgs(a.loc,"PE",c);a.body=a.body||[];var f=b._isStrictModeExpressionStatement(a.body[0]);f&&a.body.shift(),a.body.unshift(b._instructionStatementProgStart(d)),a.body=[b._wrapInTryReThrowStatement(a.body,b._literal(b._encodeInstructionArgs(null,"E",c)),b._instructionStatementProgEnd(e,c),c.gen)],f&&a.body.unshift(b._strictModeExpressionStatement())}),this._visitor.FunctionDeclaration.add(function(a,c){b._funcId++,c.func=b._funcName(a.id.name),c.gen=a.generator,c.id=b._currentFunctionId(),c.args=b._getFunctionArguments(a);var d=b._encodeInstructionArgs(a.loc,"FS",c,{named:a.params,rest:a.rest}),e=b._encodeInstructionArgs(a.loc,"FE",c),f=b._isStrictModeExpressionStatement(a.body.body[0]);f&&a.body.body.shift(),a.body.body.unshift(b._instructionStatementFuncStart(d,c)),a.body.body=[b._wrapInTryReThrowStatement(a.body.body,b._literal(b._encodeInstructionArgs(null,"E",c)),b._instructionStatementFuncEnd(e,c),c)],f&&a.body.body.unshift(b._strictModeExpressionStatement());for(var g,h=c,i=c.parentNode,j=[];i&&j.length<4;)g=i,g.type&&j.push(g.type),i=h.parentNode,h=h.parentContext;"BlockStatement"===j[0]&&"TryStatement"===j[1]&&("Program"===j[2]?(f=b._isStrictModeExpressionStatement(g.body[0]),f&&g.body.shift(),g.body.unshift(a),c.replacement=b._empty(),f&&g.body.unshift(b._strictModeExpressionStatement())):"BlockStatement"!==j[2]||"FunctionExpression"!==j[3]&&"FunctionDeclaration"!==j[3]||(f=b._isStrictModeExpressionStatement(g.body.body[0]),f&&g.body.body.shift(),g.body.body.unshift(a),c.replacement=b._empty(),f&&g.body.body.unshift(b._strictModeExpressionStatement())))}),this._visitor.add([this._visitor.FunctionExpression,this._visitor.ArrowFunctionExpression],function(a,c){if(b._funcId++,c.gen=a.generator,c.id=b._currentFunctionId(),c.args=b._getFunctionArguments(a),a.id)c.func=b._funcName(a.id.name);else if("VariableDeclarator"===c.parentNode.type&&c.parentNode.id||_.isArray(c.parentNode)&&c.parentContext&&c.parentContext.parentNode&&"SequenceExpression"===c.parentContext.parentNode.type&&c.parentContext.parentNode.expressions&&2===c.parentContext.parentNode.expressions.length&&c.parentContext.parentNode.expressions[1]===a&&c.parentContext.parentContext.parentNode&&"VariableDeclarator"===c.parentContext.parentContext.parentNode.type&&c.parentContext.parentContext.parentNode.id)c.func=b._funcName("VariableDeclarator"===c.parentNode.type?c.parentNode.id.name:c.parentContext.parentContext.parentNode.id.name);else if("AssignmentExpression"===c.parentNode.type)c.func=b._funcName(c.parentNode._leftName||"expression");else if(!c.parentNode.key||c.parentNode.value!==a||"Identifier"!==c.parentNode.key.type&&"Literal"!==c.parentNode.key.type){var d=b._originalParent(c);if(b._isArgument(d,a))c.func=b._argumentFuncName(d);else if(d&&"CallExpression"===d.type&&d.callee===a)c.func=anonymousIIFENameBuilder();else if(d&&"ReturnStatement"===d.type)c.func=anonymousReturnNameBuilder(c.func);else{var e=b._originalParent(c.parentContext),f=b._originalParent((c.parentContext||{}).parentContext);d&&"MemberExpression"===d.type&&d.object===a&&e.callee===d&&b._isArgument(f,e)?c.func=b._argumentFuncName(f):c.func=anonymousNameBuilder()}}else"Identifier"===c.parentNode.key.type?c.func=b._funcName(c.parentNode.key.name):c.func=b._funcName(c.parentNode.key.value);if("ArrowFunctionExpression"===a.type&&a.expression){var g=b._encodeInstructionArgs(a.body.loc,"R",c);a.body=b._wrapInBlock([b._return(b._sequence([b._instruction(b._encodeInstructionArgs(a.loc,"RB",c),c,a.loc),b._instructionReturn(g,c,a.body)]))]),a.expression=!1}var h=b._encodeInstructionArgs(a.loc,"FS",c,{named:a.params,rest:a.rest}),i=b._encodeInstructionArgs(a.loc,"FE",c),j=b._isStrictModeExpressionStatement(a.body.body[0]);j&&a.body.body.shift(),a.body.body.unshift(b._instructionStatementFuncStart(h,c)),a.body.body=[b._wrapInTryReThrowStatement(a.body.body,b._literal(b._encodeInstructionArgs(null,"E",c)),b._instructionStatementFuncEnd(i,c),c)],j&&a.body.body.unshift(b._strictModeExpressionStatement())})};Instrumentor.prototype._isStrictModeExpressionStatement=function(a){return a&&"ExpressionStatement"===a.type&&a.expression&&"Literal"===a.expression.type&&"use strict"===a.expression.value},Instrumentor.prototype._isArgument=function(a,b){return a&&"CallExpression"===a.type&&a.arguments&&a.callee&&a.arguments.length&&~a.arguments.indexOf(b)},Instrumentor.prototype._argumentFuncName=function(a){var b=this;return anonymousArgNameBuilder(b._funcName((a._calleeName||"expression")+("Literal"===a.arguments[0].type?" "+a.arguments[0].value:"")))},Instrumentor.prototype._originalParent=function(a){if(!a)return a;for(var b=a.parentNode;b&&(!b.type||!b.loc);)b=a.parentContext&&a.parentContext.parentNode,a=a.parentContext;return b},Instrumentor.prototype.run=function(a){var b={},c=this;return b.time=c._profile(function(){var d=_.isObject(c._options.sourceMap),e=c._options.prettify;d&&(e=!1);var f,g=c._options.compact,h="",i="",j="",k={format:{indent:{style:"  ",base:0}}},l=c._options.file&&urlUtil.parse(c._options.file).pathname;l=l&&l.substring(l.lastIndexOf("/")+1),b.timeParse=c._profile(function(){f=c._parse(a)});var m=function(){h=escodegen.generate(f,k),f=c._parse(h)};if(b.timePrettify=c._profile(function(){if(e===!0)m(),i="irrelevant (prettified)";else if(e===!1)h=a,i="irrelevant (not prettified)";else{h=a;var b=h.length,c=h.split(/\r\n|\r|\n/).length;i=120*c/b,i<1&&m()}}),g){var n={},o=0,p=function(){return c._options.fileId+"_"+o++},q=_.bind(Instrumentor.prototype._encodeInstructionArgs,c),r=function(a,b,c,d){var e=p();return n[e]=q(a,b,c,d),e};c._encodeInstructionArgs=_.bind(r,c)}if(b.timeTraverse=c._profile(function(){c._traverseDown(f,c._visitor)}),c._options.sourceMap&&_(k).extend({sourceMapWithCode:!0,sourceMap:l+".original",sourceContent:h}),b.timeGenerate=c._profile(function(){j=escodegen.generate(f,k)}),c._options.sourceMap){var s=j.map.toString();d&&(s=c._mergeSourceMap(s,n)),b.code=j.code+"\n//# sourceMappingURL=data:application/json;base64,"+new Buffer(s).toString("base64"),b.originalCode=h}else b.code=j,b.originalCode=h;g&&(b.map=n,b.map.functionsInFile=c._funcId),b.minRatio=i}),b},Instrumentor.prototype._patchInstrumentationMap=function(a,b){var c=new SourceMapConsumer(a),d=_.reduce(a.sources,function(a,b,c){return a[b]=c,a},{});_.each(b,function(a,e){if("functionsInFile"!==e){var f=a.split(";");if(f){for(var g=0,h=f.length;g<h;g++)if(f[g]){var i=f[g].split(","),j=parseInt(i[0],10),k=parseInt(i[2],10);if(!_.isNumber(j)||!_.isNumber(k))return;var l=c.originalPositionFor({line:j,column:k});if(!l||!l.source)return;i.push(l.line),i.push(l.column),i.push(d[l.source]),f[g]=i.join(",")}b[e]=f.join(";")}}})},Instrumentor.prototype._mergeSourceMap=function(a,b){var c=this,d=c._options.sourceMap.map,e=JSON.parse(sourceMapTransfer({fromSourceMap:a,toSourceMap:d}));return e.sourcesContent=_.map(c._options.sourceMap.files,function(a){return a.code}),c._patchInstrumentationMap(d,b),JSON.stringify(e)},Instrumentor.prototype._parse=function(a){var b=this;return new parser({locations:!0,ecmaVersion:7,allowImportExportEverywhere:!0,allowReturnOutsideFunction:b._options.allowReturnOutsideFunction},a).parse()},Instrumentor.prototype._profile=function(a){var b=process.hrtime();a();var c=process.hrtime(b);return 1e3*c[0]+c[1]/1e6},Instrumentor.prototype._traverseDown=function(a,b,c){var d,e,f=this;if(c||(c={}),a.type&&a.loc){var g=b[a.type];if(void 0===g&&console.error("Undefined handler "+a.type),g(a,c),"Identifier"===a.type||"Literal"===a.type||"ThisExpression"===a.type||"DebuggerStatement"===a.type||"EmptyStatement"===a.type||"BreakStatement"===a.type||"ContinueStatement"===a.type)return}for(var h in a)a.hasOwnProperty(h)&&"loc"!==h&&"type"!==h&&"start"!==h&&"end"!==h&&"name"!==h&&(d=a[h],d&&_.isObject(d)&&(e={parentContext:c,parentNode:a,func:c.func,gen:c.gen,id:c.id,args:c.args},f._traverseDown(d,b,e),e.replacement&&(a[h]=e.replacement)))},Instrumentor.prototype._nodeVisitorConstructor=function(){var a={};return a.add=function(a,b){for(var c=0,d=a.length;c<d;c++)a[c].add(b)},_(["AssignmentExpression","AssignmentPattern","ArrayExpression","ArrayPattern","ArrowFunctionExpression","BlockStatement","BinaryExpression","BreakStatement","CallExpression","CatchClause","ClassBody","ClassDeclaration","ClassExpression","ComprehensionBlock","ComprehensionExpression","ConditionalExpression","ContinueStatement","DoWhileStatement","DebuggerStatement","EmptyStatement","ExportBatchSpecifier","ExportDefaultDeclaration","ExportNamedDeclaration","ExportSpecifier","ExpressionStatement","ForOfStatement","ForStatement","ForInStatement","FunctionDeclaration","FunctionExpression","GeneratorExpression","Identifier","IfStatement","ImportDeclaration","ImportSpecifier","Literal","LabeledStatement","LogicalExpression","MemberExpression","MethodDefinition","ModuleDeclaration","NewExpression","ObjectExpression","ObjectPattern","Program","Property","RestElement","ReturnStatement","SequenceExpression","SpreadElement","SwitchStatement","SwitchCase","TaggedTemplateExpression","TemplateElement","TemplateLiteral","ThisExpression","ThrowStatement","TryStatement","UnaryExpression","UpdateExpression","VariableDeclaration","VariableDeclarator","WhileStatement","WithStatement","YieldExpression"]).each(function(b){var c=[];a[b]=function(a,b){for(var d=0,e=c.length;d<e;d++)c[d](a,b)};var d=a[b];d.add=function(a){c.push(a)}}),a},Instrumentor.prototype._getFunctionArguments=function(a){var b=this,c=b._rest(a);return c?b._instructionBuilder([{type:"ArrayExpression",elements:b._paramsArray(a)},c.argument],this._options.insFuncArgsName):"ArrowFunctionExpression"===a.type?{type:"ArrayExpression",elements:b._paramsArray(a)}:this._identifier("arguments")},Instrumentor.prototype._rest=function(a){return _.find(a.params,function(a){return"RestElement"===a.type})},Instrumentor.prototype._paramsArray=function(a){return _.compact(_.map(a.params,function(a){switch(a.type){case"ObjectPattern":return{type:"ObjectExpression",properties:a.properties};case"ArrayPattern":return{type:"ArrayExpression",elements:a.elements};case"RestElement":return null;default:return a}}))||[]},Instrumentor.prototype._wrapInBlock=function(a){return{type:"BlockStatement",body:a}},Instrumentor.prototype._instructionStatement=function(a,b){return{type:"ExpressionStatement",expression:this._instruction(a,b)}},Instrumentor.prototype._instructionStatementFuncStart=function(a,b){return{type:"ExpressionStatement",expression:this._instructionFuncStart(a,b)}},Instrumentor.prototype._instructionStatementFuncEnd=function(a,b){return{type:"ExpressionStatement",expression:this._instructionFuncEnd(a,b)}},Instrumentor.prototype._instructionStatementProgStart=function(a){return{type:"ExpressionStatement",expression:this._instructionProgStart(a)}},Instrumentor.prototype._instructionStatementProgEnd=function(a,b){return{type:"ExpressionStatement",expression:this._instructionProgEnd(a,b)}},Instrumentor.prototype._instruction=function(a,b,c){var d=this._instructionArgs(a),e=this._options.insFuncName;return b.gen&&(e=this._options.insGenFuncName,d.unshift(this._literal(b.id)),d.splice(2,0,b.args)),this._instructionBuilder(d,e,c)},Instrumentor.prototype._instructionReturn=function(a,b,c,d){var e,f=this._instructionArgs(a);return f.unshift(this.fileIdLiteral),c?(f.splice(2,0,c),e=this._options.insFuncReturnName,b.gen&&(e=this._options.insGenFuncReturnName,f.unshift(this._literal(b.id)),f.splice(3,0,b.args)),this._instructionBuilder(f,e,d)):(e=this._options.insFuncReturnUndefinedName,b.gen&&(e=this._options.insGenFuncReturnUndefinedName,f.unshift(this._literal(b.id)),f.splice(3,0,b.args)),this._instructionBuilder(f,e,d))},Instrumentor.prototype._instructionFuncStart=function(a,b){var c=this._instructionArgs(a);c.unshift(this.fileIdLiteral),c.splice(2,0,b.args);var d=this._options.insFuncFuncStartName;return b.gen&&(d=this._options.insGenFuncFuncStartName,c.unshift(this._literal(b.id))),this._instructionBuilder(c,d)},Instrumentor.prototype._instructionBeforeYield=function(a,b,c,d){var e=this._instructionArgs(a);return e.unshift(c.args),e.unshift(b),e.unshift(this._literal(c.id)),this._instructionBuilder(e,this._options.insFuncBeforeYieldName,d)},Instrumentor.prototype._instructionAfterYield=function(a,b,c){return this._instructionBuilder([this._literal(b.id),this._sequence([this._literal(0),a]),b.args,this._timeStampCall()],this._options.insFuncAfterYieldName,c)},Instrumentor.prototype._instructionFuncEnd=function(a,b){var c=this._instructionArgs(a);this._options.insertExpressionEvaluators&&(c=c.concat(this._expressionEvaluator(b)));var d=this._options.insFuncFuncEndName;return b.gen&&(d=this._options.insGenFuncFuncEndName,c.unshift(this._literal(b.id)),c.splice(2,0,b.args)),this._instructionBuilder(c,d)},Instrumentor.prototype._instructionProgStart=function(a){var b=this._instructionArgs(a);return b.unshift(this.fileIdLiteral),this._instructionBuilder(b,this._options.insFuncProgStartName)},Instrumentor.prototype._instructionProgEnd=function(a,b){var c=this._instructionArgs(a);return this._options.insertExpressionEvaluators&&(c=c.concat(this._expressionEvaluator(b))),this._instructionBuilder(c,this._options.insFuncProgEndName)},Instrumentor.prototype._instructionBuilder=function(a,b,c){return c&&(c={start:{line:c.start.line,column:c.start.column},end:{line:c.start.line,column:c.start.column+1}}),{type:"CallExpression",callee:{type:"Identifier",name:this._options.insObjName+b,loc:c},arguments:a}},Instrumentor.prototype._instructionArgs=function(a){return a?[this._literal(a),this._timeStampCall()]:[]},Instrumentor.prototype._timeStampCall=function(){return{type:"CallExpression",callee:{type:"Identifier",name:this._options.insObjName+this._options.timeFuncName},arguments:[]}},Instrumentor.prototype._literal=function(a){return{type:"Literal",value:a}},Instrumentor.prototype._sequence=function(a){return{type:"SequenceExpression",expressions:a}},Instrumentor.prototype._empty=function(){return{type:"EmptyStatement"}},Instrumentor.prototype._identifier=function(a){return{type:"Identifier",name:a}},Instrumentor.prototype._return=function(a){return{type:"ReturnStatement",argument:a}},Instrumentor.prototype._strictModeExpressionStatement=function(){return{type:"ExpressionStatement",expression:{type:"Literal",value:"use strict"}}},Instrumentor.prototype._wrapInTryReThrowStatement=function(a,b,c,d){var e=[this.fileIdLiteral,b,this._identifier(this._options.exIdentifier),this._timeStampCall()],f=this._options.insFuncExceptionName;return d.gen&&(e.unshift(this._literal(d.id)),e.splice(3,0,d.args),f=this._options.insGenFuncExceptionName),{type:"TryStatement",block:this._wrapInBlock(a),guardedHandlers:[],handlers:[{type:"CatchClause",param:{type:"Identifier",name:this._options.exIdentifier},body:{type:"BlockStatement",body:[{type:"ExpressionStatement",expression:this._instructionBuilder(e,f)},{type:"ThrowStatement",argument:{type:"Identifier",name:this._options.exIdentifier}}]}}],finalizer:{type:"BlockStatement",body:[c]}}},Instrumentor.prototype._currentFunctionId=function(){var a=this;return a._options.fileId+"_"+a._funcId},Instrumentor.prototype._expressionEvaluator=function(a){var b=this,c=b._options.insObjName+b._options.insFuncScopeEvaluatorName;return[{type:"Identifier",name:"this"},b._literal(c+a.id),{type:"FunctionExpression",params:[{type:"Identifier",name:b._options.expIdentifier}],defaults:[],body:{type:"BlockStatement",body:[{type:"ReturnStatement",argument:{type:"CallExpression",callee:{type:"Identifier",name:"eval"},arguments:[{type:"CallExpression",callee:{type:"Identifier",name:c},arguments:[{type:"Identifier",name:b._options.expIdentifier}]}]}}]},generator:!1,expression:!1}]},Instrumentor.prototype._encodeInstructionArgs=function(a,b,c,d){if(d){for(var e="",f=0,g=d.named.length;f<g;f++){var h=d.named[f];e+=";"+this._encodeLocAndType(h.loc,h.name||f)}d.rest&&(e+=";"+this._encodeLocAndType(d.rest.loc,d.rest.name)),d=e}else d="";return this._encodeLocAndType(a,b)+","+c.func+","+c.id+d},Instrumentor.prototype._funcName=function(a){return this._last(a?a.toString():"",50).replace(/,/g,".").replace(/;/g," ").replace(/:/g," ").replace(/'/g,'"')},Instrumentor.prototype._last=function(a,b){var c=a.length;return b>=c?a:"..."+a.substr(c-b)},Instrumentor.prototype._encodeLocAndType=function(a,b){var c="",d="",e="",f="";return a&&(c=a.start.line,d=a.end.line,e=a.start.column,f=a.end.column),c+","+d+","+e+","+f+","+b};var run=function(a,b){var c=new Instrumentor(b);return c.run(a)};module.exports={run:run,Instrumentor:Instrumentor};