/*
 * spy-js - v2.0.0
 * http://spy-js.com
 * Copyright (c) 2013-2017 JetBrains - All Rights Reserved.
 *
 * This source code file is a part of spy-js plugin.
 */
var http=require("http"),util=require("util"),EventEmitter=require("events").EventEmitter,express=require("express"),useragent=require("useragent"),SessionCore=require("./sessionCore"),urlUtil=require("./urlUtil"),proxyUtil=require("./proxyUtil"),_=_spy_js._,Session=function(a,b){var c=this;c._processingCache={},c._urlEncodingCache={},c._refererCache={},c._workQueue=b,c._disposed=!1,c._disconnected=!1,c._fileId=1,c._filters={},c._browserUpdateCache={},c._browserConnections={},c._core=new SessionCore(a),c._core.on("event.session.start",function(a){c._core.proxyPort()&&c._startProxy(),c.info("new"+(a.code?"":" global")+" session started: "+c.id())}),c._core.on("event.session.change",function(){c.info("existing session changed: "+c.id()),c._core.proxyPort()?c._startProxy():c._stopProxy()}),c._core.on("event.session._disconnect",function(){c.info("existing session disconnected: "+c.id()),c._disconnected=!0,c._stopProxy()}),c._core.on("event.config.change",function(a){c._filters=a.filter,_.chain(c._browserUpdateCache).values().each(function(a){_.extend(a,{pending:!0})})}),c._core.on("event.browser.execute",function(a){var b=c._browserUpdateContext(a.streamId);b.oneTimeCode+=a.command,b.pending=!0}),c._core.on("event.session.reconnect",function(){c.info("existing session reconnected: "+c.id()),c._disconnected=!1,c._core.proxyPort()&&c._startProxy()}),c._core.on("event.session.dispose",function(){c.info("existing session disposed: "+c.id()),c._processingCache={},c._browserUpdateCache={},c._urlEncodingCache={},c._refererCache={},c._stopProxy(),c._proxyServer=null,c._disposed=!0}),c._core.on("event.expression.evaluate",_.bind(c._evaluate,c)),c._core.created()};Session.prototype=_.extend(Object.create(EventEmitter.prototype),{id:function(){return this._core.id()},root:function(){return this._core.root()},global:function(){return this._core.global()},data:function(a,b,c){var d=this;d._touchEventContext(a.streamContext),d._processData(a,b,c)},info:function(a){var b=this;b._core.info(a)},warn:function(a){var b=this;b._core.warn(a)},error:function(a){var b=this;b._core.error(a)},updateSocket:function(a){var b=this;b._core.updateSocket(a)},mapScript:function(a){return this._core.config(a)},setScript:function(a,b,c,d){var e=this;e._instrumentCache(b,a,c,function(b,c){b?(e.error(b),d(a)):d(c)})},containsScript:function(a){var b=this;return b._core.isCached(a)},getScript:function(a,b){var c=this;b(c._core.lastCachedInstrumentedCode(a))},specialEncoding:function(a,b){var c=this;c._urlEncodingCache[a]=b},getEncoding:function(a){var b=this;return b._urlEncodingCache[a]||"utf8"},serverHost:function(a){var b=this;return a?void(b._host=a):b._host},active:function(){var a=this;return a._core.isActive()},sourceMapLookupEnabled:function(){var a=this;return a._core.isSourceMapLookupEnabled()},sourceMapGenerationEnabled:function(){var a=this;return a._core.isSourceMapGenerationEnabled()},dispose:function(){var a=this;a._disposed||a._core.dispose()},newBrowserConnection:function(a,b){var c=this,d=c._browserConnections[a]||{id:a,listeners:{touch:function(){c._initializeConnectionExpiration(d)},disconnect:function(){d._destructor()}}};c._initializeConnectionExpiration(d),c._initializeSocket(d,b),c._browserConnections[a]=d},_initializeConnectionExpiration:function(a){var b=this;a.destructor&&clearInterval(a.destructor),a._destructor=function(){a.destructor&&clearInterval(a.destructor),a.socket&&_.chain(a.listeners).pairs().each(function(b){a.socket.removeListener(b[0],b[1])}),delete b._browserConnections[a.id],b._core.info("browser connection "+a.id+" expired")},a.destructor=setInterval(a._destructor,3e4)},_initializeSocket:function(a,b){a.socket&&_.chain(a.listeners).pairs().each(function(b){a.socket.removeListener(b[0],b[1])}),a.socket=b,_.chain(a.listeners).pairs().each(function(a){b.on(a[0],a[1])})},_startProxy:function(){var a=this;a._stopProxy();var b=express();a._proxyServer=http.createServer(b),b.use(express.compress()),b.use(function(b,c,d){if(a._disposed||a._disconnected||!a.active())return c.writeHead(200,{"Content-Type":"text/plain"}),c.end("Make sure spy-js session with local proxy mode is started and active and keep reloading this page until you see your proxied page"),void b.connection.destroy();if(!proxyUtil.handleSpecialResources(b,c,d)){b.url=urlUtil.join(a.root(),b.url),b.parsedUrl=urlUtil.parse(b.url),b.parsedRefererUrl=urlUtil.parse(urlUtil.normalizedUrl(b.headers.referer||"")),b.headers.host=b.parsedUrl.host;try{proxyUtil.handleBySession(a,b,c)}catch(b){a.error(b)}}}),b.use(express.json({limit:"50mb"})),b.use("/ui-event-handler",function(b,c){a.sendBrowserData(c,(b.body||{}).streamContext),a.data(b.body,b.headers["user-agent"],b.headers.referer)}),a._proxyServer.once("error",function(b){b&&"EADDRINUSE"==b.code?a.error("Can not start local proxy, port "+a._core.proxyPort()+" is already in use (possibly by another running tracing session)"):a.error(util.inspect(b))}),a._proxyServer.listen(a._core.proxyPort(),function(){a.info("local proxy started: localhost:"+a._core.proxyPort())}),a._proxyServer.once("close",function(){a.info("local proxy stopped")})},sendBrowserData:function(a,b){var c=this;a.set("Cache-Control","no-cache, no-store, must-revalidate");var d=c._browserUpdateContext(b);a.send(d.pending?(d.pending=!1,c._browserData(d)):{})},trackReferer:function(a,b){var c=this;b?c._refererCache[a]=c._refererCache[b]||b:c._refererCache[a]=a},_browserData:function(a){var b=this,c=a.oneTimeCode||void 0,d=a.properties;return a.oneTimeCode="",delete a.properties,{files:b._filters.files,events:b._filters.events,code:c,properties:d}},_stopProxy:function(){var a=this;a._proxyServer&&(a._proxyServer.close(),a._proxyServer=null)},_newContext:function(a,b,c,d){var e=this,f=useragent.parse(c),g={id:a,doc:b,agent:f.toString(),referrer:e._refererCache[d]};return e._core.newContext(g),g},_processData:function(a,b,c){var d=this,e=a.streamContext;if(a.data.length){for(var f,g=d._processingCache[e]=d._processingCache[e]||d._newContext(e,a.doc,b,c),h=!d._core.hasFilter(),i=[],j=-1,k={},l=function(){d._core.newEvent({streamId:e,eventId:j,data:i},{globalScope:g.globalScope,files:k,lastEntry:d._fillContext(f||d._decodeFullEntry(i[i.length-1]),g),firstEntry:d._fillContext(d._decodeFullEntry(i[0]),g)}),i=[],k={},f=null},m=0,n=a.data.length;m<n;m++){var o=a.data[m],p=d._decodeFullEntry(o);if(0!==p.eventContext){var q=p.callData.split(";")[0],r=d._core.fileIdFromInsMapId(q),s=d._core.instrumentationMapByFileId(r);if(s&&s.value){var t=q;if(q=s.value[q],!q){d.info("Unable to find "+t+" key in "+s.sourceUrl+" file map. The map is empty: "+_(s.value).isEmpty()+", the map file id is: "+s.fileId);break}q=q.split(",");var u=q[4];if(d._setEntryType(o,u),p.eventContext?p.globalScope="PS"==u?s.sourceUrl:void 0:d._fillContext(p,g),j!=p.eventContext&&(i.length&&l(),j=p.eventContext,d._fillContext(g,p)),p.time&&(f=p),k[r]||(k[r]=s.sourceUrl),"PS"===u||"FS"===u){var v=q[6].split(";")[0].split("_")[1];d._core.functionEncountered(e,j,r,v,t)}h?i.push(o):d._core.filter(p)||i.push(o)}}else d._core.eventInterruption(e)}return i.length&&l(),a.data=i,a}},_fillContext:function(a,b){return a.eventContext=b.eventContext,a.pageEvent=b.pageEvent,a.isFromSetTimeout=b.isFromSetTimeout,a.isFromSetInterval=b.isFromSetInterval,a.globalScope=b.globalScope,a},_decodeFullEntry:function(a){return{callData:a[0],pageEvent:a[1],isFromSetTimeout:1===a[2],isFromSetInterval:2===a[2],time:a[3],eventContext:a[4],objDump:a[5],type:a[6],id:a.id}},_setEntryType:function(a,b){a[6]=b},_newFileId:function(){return(this._fileId++).toString()},_instrumentCache:function(a,b,c,d){var e=this;if(a.instrument){var f=a.instrument&&!a.instrument.verbose;if(f)var g=e._core.fileIds(a.url)[0]||e._newFileId();"debug"===process.env.NODE_ENV&&(e._workQueue.enqueue=function(a,b){try{var c=require("./instrument").run(a.code,{file:a.file,fileId:a.fileId,prettify:a.prettify,compact:a.compact,insertExpressionEvaluators:a.insertExpressionEvaluators,sourceMap:a.sourceMap});b({instrumentedCode:c.code,originalCode:c.originalCode,map:c.map,minRatio:c.minRatio,time:c.time})}catch(a){b({error:{message:a&&a.message,stack:a&&a.stack}})}}),e._workQueue.enqueue({code:b,file:a.url,fileId:g,prettify:a.instrument&&a.instrument.prettify,compact:f,insertExpressionEvaluators:e._core.realtimeEvaluation(),sourceMap:c||e.sourceMapGenerationEnabled()},function(h){if(e.active()){if(h.error)return e.error({message:"Error in worker while parsing "+a.url,err:{message:h.error.message}}),void d(null,b);var i="";a.instrument.objectDump&&(i='window.__p.limits["'+g+'"] = {lvl:'+a.instrument.objectDump.depth+",prop:"+a.instrument.objectDump.propertyNumber+",arr:"+a.instrument.objectDump.arrayLength+",str:"+a.instrument.objectDump.stringLength+"};");var j='window.__p.registerFile({id:"'+g+'",url:"'+a.url+'"});',k={sourceUrl:a.url,instrumentedCode:e._tracerLoadingCode(h.instrumentedCode,i+j),originalCode:h.originalCode,mtime:(new Date).getTime(),instrumentationMap:h.map,fileId:g,compact:f,sourceMappedFiles:c&&c.files};e._core.cache(k),e.info("script ["+a.url+"] is instrumented and cached in "+e._formatIfNumber(h.time)+" ms, prettify ratio: "+e._formatIfNumber(h.minRatio)),d(null,k.instrumentedCode)}})}else d(null,e._tracerLoadingCode(b,""))},_formatIfNumber:function(a){return _.isNumber(a)?a.toFixed(4):a},_tracerLoadingCode:function(a,b){var c=this;return'if(!window.__p){ window.originalSetTimeout = setTimeout;window.originalSetInterval = setInterval;eval("var setTimeout, setInterval;");setTimeout = function () { return Function.prototype.apply.call(window.newSetTimeout, null, arguments); };setInterval = function () { return Function.prototype.apply.call(window.newSetInterval, null, arguments); };  }(function (){ if(window.__p) { '+b+" return; }window.__p = {};window.__p.sessionId='"+c.id()+"';window.__p.spyRootUrl='"+c.serverHost()+'\';if (!window.location.origin) window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ":" + window.location.port: "");var request = window.XMLHttpRequest ? (new window.XMLHttpRequest()) : (new ActiveXObject("Microsoft.XMLHTTP"));request.open(\'GET\', window.location.origin +\'/spy-js-tracer.js\', false);request.send();try { window.eval(request.responseText); } catch(exc) {var noOp = function () {};window.__p.registerFile = noOp;window.__pt = noOp;window.__pi = noOp;window.__pr = function (f, d, returnValue) { return returnValue; };window.__pru = noOp;window.__pf = noOp;window.__pp = noOp;window.__pfe = noOp;window.__ppe = noOp;window.__pe = noOp;window.__pv = noOp;window.newSetTimeout = window.originalSetTimeout;window.newSetInterval = window.originalSetInterval;}window.__p.limits = {};'+b+"})();"+a},_browserUpdateContext:function(a){var b=this,c=b._browserUpdateCache[a];return c||(c=b._browserUpdateCache[a]={pending:!0}),c},_touchEventContext:function(a){var b=this,c=b._browserUpdateContext(a);clearTimeout(c.expirationTimeout),c.expired&&(b._core.contextActivated(a),c.expired=!1),c.expirationTimeout=setTimeout(function(){b._core.contextExpired(a),c.expired=!0},5e3)},_evaluate:function(a,b){var c=this,d=Object.keys(c._browserConnections).length,e={},f={},g=function(){clearTimeout(i),f.properties=_(e).values(),f.error&&(c.info("Error while evaluating "+a.expression+" in one of the browsers: "+f.error),delete f.error),a.autocomplete||f.value||c.info("Result value is expected but was not calculated"),b(f)};a.file=c._core.fileIds(a.file)[0],a.file||(f.fileNotFound=!0,g());var h=function(a){return"key_"+a},i=setTimeout(g,a.timeout);_.chain(c._browserConnections).values().each(function(b){try{b.socket.emit("evaluate",a,function(a){try{_.extend(f,_.omit(a,"properties")),_.each(a.properties,function(a){var c=e[h(a.name)]=e[h(a.name)]||a;c.context=c.context||[],c.context.push(b.id)})}catch(a){c.error({message:"Error while processing expression evaluation result",err:a})}finally{d--,0===d&&g()}})}catch(a){c.error({message:"Error while connecting to browser to evaluate expression",err:a}),d--}})}}),module.exports=Session;