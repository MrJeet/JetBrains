/*
 * spy-js - v2.0.0
 * http://spy-js.com
 * Copyright (c) 2013-2017 JetBrains - All Rights Reserved.
 *
 * This source code file is a part of spy-js plugin.
 */
var Module=require("module").Module,modulePrototype=Module.prototype,EventEmitter=require("events").EventEmitter,SessionCore=require("./sessionCore"),Tracer=require("./tracerNode"),os=require("os"),path=require("path"),_=_spy_js._,SessionNode=function(a,b,c){var d=this;d._eventId=1,d._childProcess=c.childProcess,d._childProcessSenders=[],d._parentProcessSender=null;var e=c.currentSpyArgs;d._childProcess&&(a=new EventEmitter,a.handshake={sessionID:d._randomId()},process.on("internalMessage",function(b){b=d._internalMessage(b),b.event&&(b.toTopmostParent?d._sendToParentProcess(b.event,b.data):(a.emit(b.event,b.data,function(){}),b.toAllChildren&&d._broadcastToChildProcesses(b.event,b.data),"exit"===b.event&&(d.dispose(),process.exit())))}),d._parentProcessSender=process.send&&_.bind(process.send,process)),d._core=new SessionCore(a,["config.file.change","file.cache.clear"],d._childProcess);var f={id:d._randomId(),agent:"node.js",doc:b+" (PID: "+process.pid+")"};d._core.created(),d._tracer=new Tracer(d._core,f.id,c),d._core.on("event.config.change",function(a){d._externalConfig=a}),d._core.on("event.expression.evaluate",_.bind(d._evaluate,d)),d._core.on("event.session.start",function(c){if(d._childProcess){f.referrer=((c.config||{}).parent||{}).doc;var g=(c.config||{}).externalConfig;g&&a.emit("config.change",g,function(){}),d._core.on("event.item.cache",function(a){d._sendToParentProcess("event.item.cache",a)}),d._tracer.on("data",function(a){d._sendToParentProcess("trace.data",a)}),d._core.info("----------- Starting traced child process ("+process.pid+") -----------","blue"),d._sendToParentProcess("context.new",f)}else d._tracer.on("data",_.bind(d._processTraceData,d)),d._core.info("----------- Starting traced application process ("+process.pid+") -----------","blue"),d._core.newContext(f);d._core.on("event.config.change",function(a){d._broadcastToChildProcesses("config.change",a)});var h=modulePrototype.load;modulePrototype.load=function(){return modulePrototype.load=h,process.mainModule=this,this.id=".",this.parent=null,h.apply(this,arguments)},Object.keys(require.cache).forEach(function(a){delete require.cache[a]}),d._patchChildProcessSpawn(e,b,c.config,d._childProcessSenders,f),process.argv&&process.argv.length&&process.argv.splice(1,e.length,b),d._tracer.start();try{require(Module._resolveFilename(b))}catch(a){a&&a.stack&&(a.stack=a.stack.toString().split(/\r\n|\n/).filter(function(a){return!/(tracerNode|spyNode|sessionNode)\.js/.test(a)}).join(os.EOL)),d._core.error(a)}})};SessionNode.prototype=_.extend(Object.create(EventEmitter.prototype),{id:function(){return this._core.id()},root:function(){return this._core.root()},global:function(){return this._core.global()},updateSocket:function(a){var b=this;b._core.updateSocket(a)},dispose:function(){var a=this;a._disposed||(a._broadcastToChildProcesses("exit",{}),a._tracer.dispose(),a._core.dispose(),a._childProcessPrototype&&a._childProcessOriginalSpawn&&(a._childProcessPrototype.spawn=a._childProcessOriginalSpawn))},_evaluate:function(a,b){var c=this,d=c._core.isCached(a.file),e=!c._childProcess,f=c._internalMessage("expression.evaluate",a);e?d&&c._core.lastCachedFromChildProcess(a.file)?(c._childProcessEvaluationCallbackData={callback:b,request:a},c._sendToChildProcesses(f)):c._tracer.evaluate(a,b):d?c._tracer.evaluate(a,function(b){b.request=a,c._childProcessMessage(c._internalMessage("event.expression.evaluate",b))}):c._sendToChildProcesses(f)},_broadcastToChildProcesses:function(a,b){var c=this,d=c._internalMessage(a,b);d.toAllChildren=!0,c._sendToChildProcesses(d)},_sendToChildProcesses:function(a){var b=this;_.each(b._childProcessSenders,function(c){try{c(a)}catch(a){b._core.error({message:"Failed to send a tracing related message to child process",err:a})}})},_sendToParentProcess:function(a,b){var c=this;if(c._parentProcessSender){var d=c._internalMessage(a,b);d.toTopmostParent=!0;try{c._parentProcessSender(d)}catch(a){c._core.error({message:"Failed to send a tracing related message to parent process",err:a})}}},_internalMessage:function(a,b){var c="NODE_spyJs";return b?{cmd:c,event:a,data:b}:a.cmd===c?{event:a.event,data:a.data}:a},_patchChildProcessSpawn:function(a,b,c,d,e){var f=this;if(!f._childProcessPrototypeReplaced){global._forceNormalRequire=!0;var g=require("child_process"),h="_void_";f._childProcessPrototype=g.spawn(h).on("error",function(){}).__proto__,f._childProcessOriginalSpawn=f._childProcessPrototype.spawn,f._childProcessPrototype.spawn=function(g){var i=a.slice(),j=g.file!==h&&g.file===process.execPath;if(j){for(var k=0,l=[],m=1;m<g.args.length;m++){var n=g.args[m];!k&&n&&"-"!==n[0]&&(k=m),n&&_.str.startsWith(n,"--spyJs")&&l.push(n)}if(g.args=_.difference(g.args,l),k<g.args.length){for(var o=0;o<i.length;o++)if(~i[o].indexOf("--spyJsChildProc="))i[o]="--spyJsChildProc=true";else if(~i[o].indexOf("--spyJsTracedApp=")){var p=g.args[k];~p.indexOf(path.sep)||~p.indexOf("/")||(p=path.join(process.cwd(),p)),i[0]!==p&&(i[o]=i[o].replace(b,p))}g.args.splice.apply(g.args,[k,1].concat(i)),this.on("internalMessage",_.bind(f._childProcessMessage,f))}}var q=f._childProcessOriginalSpawn.call(this,g);if(j&&this.send){c.parent=e,c.externalConfig=f._externalConfig,this.send(f._internalMessage("session.start",c));var r=_.bind(this.send,this);d.push(r),this.on("close",function(){d.splice(d.indexOf(r),1)})}return q},global._forceNormalRequire=!1,f._childProcessPrototypeReplaced=!0}},_randomId:function(){return Math.random().toString(36).substr(2,5)},_childProcessMessage:function(a){var b=this;a=b._internalMessage(a),b._childProcess?b._sendToParentProcess(a.event,a.data):"trace.data"===a.event?b._processTraceData(a.data):"event.item.cache"===a.event?(a.data.fromChildProcess=!0,b._core.cache(a.data)):"context.new"===a.event?b._core.newContext(a.data):"event.expression.evaluate"===a.event&&b._childProcessEvaluationCallbackData&&_.isEqual(a.data.request,b._childProcessEvaluationCallbackData.request)&&(b._childProcessEvaluationCallbackData.callback(a.data),delete b._childProcessEvaluationCallbackData)},_processTraceData:function(a){var b=this,c=a.streamId;a=a.entries;for(var d=0,e=a.length;d<e;d++){var f=a[d];if(f.truncated)b._core.eventInterruption(c);else{var g,h=[],i={},j={},k=f.length;if(k){for(var l=0;l<k;l++){var m=f[l];m.time&&(m.time=1e3*m.time[0]+m.time[1]/1e6);var n=m.callData.split(";")[0],o=b._core.fileIdFromInsMapId(n),p=b._core.instrumentationMapByFileId(o);if(p&&p.value){var q=n;if(n=p.value[n],!n){b._core.info("Unable to find "+q+" key in "+p.sourceUrl+" file map. The map is empty: "+_(p.value).isEmpty()+", the map file id is: "+p.fileId);break}n=n.split(",");var r=n[4];m.type=r;var s=b._encodeEntry(m);if(m.eventContext?m.globalScope="PS"==r?p.sourceUrl:void 0:b._fillContext(m,i),0===l&&b._fillContext(i,m),m.time&&(g=m),j[o]||(j[o]=p.sourceUrl),"PS"===r||"FS"===r){var t=n[6].split(";")[0].split("_")[1];b._core.functionEncountered(c,b._eventId,o,t,q)}h.push(s)}}b._core.newEvent({streamId:c,eventId:b._eventId++,data:h},{globalScope:i.globalScope,files:j,lastEntry:b._expandEventContextType(b._fillContext(f[k-1],i)),firstEntry:b._expandEventContextType(b._fillContext(f[0],i))})}}}},_fillContext:function(a,b){return a.eventContext=b.eventContext,a.pageEvent=b.pageEvent,a.eventContextType=b.eventContextType,a.globalScope=b.globalScope,a},_expandEventContextType:function(a){return a.isFromSetTimeout=1===a.eventContextType,a.isFromSetInterval=2===a.eventContextType,a.isFromSetImmediate=3===a.eventContextType,a},_encodeEntry:function(a){return{0:a.callData,1:a.pageEvent,2:a.eventContextType,3:a.time,4:a.eventContext,5:a.objDump,6:a.type}}}),module.exports=SessionNode;