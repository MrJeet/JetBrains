/*
 * spy-js - v2.0.0
 * http://spy-js.com
 * Copyright (c) 2013-2017 JetBrains - All Rights Reserved.
 *
 * This source code file is a part of spy-js plugin.
 */
var path=require("path"),fs=require("graceful-fs"),EventEmitter=require("events").EventEmitter,temp=require("temp"),_=_spy_js._,mkdirp=require("mkdirp"),yauzl=require("yauzl");temp.track();var root=temp.mkdirSync("spy-js-session"),FileSystemSessionStore=function(a){var b=this;b._root=root,b._sessionId=a,b._location=path.join(b._root,a),b._event=null,b._streamContexts={},fs.existsSync(b._location)||fs.mkdirSync(b._location),console.log("session store: "+b._root)};FileSystemSessionStore.prototype=_.extend(Object.create(EventEmitter.prototype),{save:function(a){var b=this,c=a.streamId,d=a.eventId,e=a.data,f=a.done;if(e){if(!b._streamContexts)throw new Error("Can not use disposed session store");var g=b._streamContexts[c];g||(g=b._streamContexts[c]={});var h=g[d]||0;e.forEach(function(a,b){a.id=b+h}),g[d]=h+e.length,fs.appendFile(b._filePath(c,d),JSON.stringify(e).slice(1,-1)+",",function(a){if(a)throw a;f&&f()})}},load:function(a){var b,c=this,d=a.done,e=a.streamId,f=a.eventId,g=a.ids||(b=!0),h=a.mapper,i=function(a){c._event={streamId:e,eventId:f,data:a},d(b?h?a.map(h):a:g.map(function(b){return h?h(a[b]):a[b]}))};c._event&&c._event.streamId===e&&c._event.eventId===f?i(c._event.data.slice(0)):fs.readFile(c._filePath(e,f),"utf8",function(a,b){if(a)return void d([],a);try{b=JSON.parse("["+b.slice(0,-1)+"]")}catch(a){return void d([],a)}i(b)})},pack:function(a){var b=this;try{var c=require("archiver"),d=c("zip"),e=b._sessionId+"-saved",f=path.join(b._root,e+".zip"),g=fs.createWriteStream(f);g.on("close",function(){a.done({file:f})}),d.on("error",function(b){a.error(b.message)}),d.pipe(g),d.append(JSON.stringify({browser:a.browser,sessionId:b._sessionId,traceFolder:e,contextEvents:a.contextEvents,scriptCache:a.scriptCache,functionCallIndex:a.functionCallIndex,fileDependencyIndex:a.fileDependencyIndex,fileIdToUrlCache:a.fileIdToUrlCache}),{name:"session.json"}),d.bulk([{expand:!0,cwd:b._location,src:["**"]}]),d.finalize()}catch(b){a.error(b&&b.message)}},unpack:function(a){var b=this;try{var c=path.basename(a.file,".zip"),d=path.join(b._root,c);yauzl.open(a.file,{lazyEntries:!0},function(c,e){if(c)throw c;e.readEntry(),e.on("entry",function(a){/\/$/.test(a.fileName)?mkdirp(path.join(d,a.fileName),function(a){if(a)throw a;e.readEntry()}):e.openReadStream(a,function(b,c){if(b)throw b;mkdirp(path.join(d,path.dirname(a.fileName)),function(b){if(b)throw b;c.pipe(fs.createWriteStream(path.join(d,a.fileName))),c.on("end",function(){e.readEntry()})})})}),e.on("close",function(){var c=path.join(d,"session.json");delete require.cache[require.resolve(c)];var e=require(c);if(e.browser!==a.browser){var f=a.browser?"browser":"node.js",g=e.browser?"browser":"node.js";return void a.error("Invalid attempt to load "+g+" saved session in "+f+" session")}b._sessionId=e.sessionId,b._location=d,a.done({scriptCache:e.scriptCache,fileIdToUrlCache:e.fileIdToUrlCache,contextEvents:e.contextEvents,functionCallIndex:e.functionCallIndex,fileDependencyIndex:e.fileDependencyIndex,id:e.sessionId})})})}catch(b){a.error(b&&b.message)}},clear:function(){var a=this;a._event=null,a._streamContexts={}},dispose:function(){var a=this;a.clear(),a._deleteFolderRecursiveSync(a._location),a._streamContexts=null},_filePath:function(a,b){var c=this;return path.join(c._location,c._sessionId+"_"+a+"_"+b+".json")},_deleteFolderRecursiveSync:function(a){var b=this,c=[];fs.existsSync(a)&&(c=fs.readdirSync(a),c.forEach(function(c){var d=a+"/"+c;fs.statSync(d).isDirectory()?b._deleteFolderRecursiveSync(d):fs.unlinkSync(d)}),fs.rmdirSync(a))}}),module.exports=FileSystemSessionStore;